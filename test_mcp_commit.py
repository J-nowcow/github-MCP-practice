#!/usr/bin/env python3
"""
MCP GitHub ì„œë²„ì˜ write ë„êµ¬ë“¤ì„ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ì»¤ë°‹ê³¼ í‘¸ì‹œë¥¼ ì§„í–‰í•˜ëŠ” í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
"""

import asyncio
import os
import sys
from pathlib import Path

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from mcp_github.tools_write import (
    create_or_update_file,
    create_branch,
    get_repository_status
)


async def test_github_operations():
    """GitHub ì‘ì—… í…ŒìŠ¤íŠ¸"""
    
    # GitHub ì €ì¥ì†Œ ì •ë³´
    owner = "J-nowcow"  # ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½
    repo = "github-MCP-practice"  # ì‹¤ì œ ì €ì¥ì†Œëª…ìœ¼ë¡œ ë³€ê²½
    
    print(f"ğŸ¯ GitHub ì €ì¥ì†Œ: {owner}/{repo}")
    print("=" * 50)
    
    try:
        # 1. í˜„ì¬ ì €ì¥ì†Œ ìƒíƒœ í™•ì¸
        print("ğŸ“Š 1. ì €ì¥ì†Œ ìƒíƒœ í™•ì¸ ì¤‘...")
        status = await get_repository_status(owner, repo)
        
        if status["success"]:
            print(f"âœ… í˜„ì¬ ë¸Œëœì¹˜: {status['data']['branch']}")
            print(f"âœ… ìµœì‹  ì»¤ë°‹: {status['data']['commit_sha'][:8]}")
            print(f"âœ… ì»¤ë°‹ ë©”ì‹œì§€: {status['data']['commit_message']}")
        else:
            print(f"âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {status['error']}")
            return
        
        print()
        
        # 2. ìƒˆ ë¸Œëœì¹˜ ìƒì„±
        new_branch = "mcp-test-branch"
        print(f"ğŸŒ¿ 2. ìƒˆ ë¸Œëœì¹˜ '{new_branch}' ìƒì„± ì¤‘...")
        
        branch_result = await create_branch(owner, repo, new_branch)
        
        if branch_result["success"]:
            print(f"âœ… ë¸Œëœì¹˜ ìƒì„± ì„±ê³µ: {new_branch}")
        else:
            print(f"âŒ ë¸Œëœì¹˜ ìƒì„± ì‹¤íŒ¨: {branch_result['error']}")
            # ê¸°ì¡´ ë¸Œëœì¹˜ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
        
        print()
        
        # 3. ìƒˆ íŒŒì¼ ìƒì„±
        test_file_path = "mcp_test/hello_mcp.md"
        test_content = """# Hello MCP! ğŸš€

ì´ íŒŒì¼ì€ **GitHub MCP ì„œë²„**ë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

## ìƒì„±ëœ ê¸°ëŠ¥ë“¤:
- âœ… íŒŒì¼ ìƒì„±/ìˆ˜ì • (`createOrUpdateFile`)
- âœ… íŒŒì¼ ì‚­ì œ (`deleteFile`)
- âœ… ë¸Œëœì¹˜ ìƒì„± (`createBranch`)
- âœ… ë‹¤ì¤‘ íŒŒì¼ ì»¤ë°‹ (`createCommitWithMultipleFiles`)
- âœ… ì €ì¥ì†Œ ìƒíƒœ ì¡°íšŒ (`getRepositoryStatus`)

## ì‚¬ìš©ë²•:
```python
from mcp_github.tools_write import create_or_update_file

result = await create_or_update_file(
    owner="your_username",
    repo="your_repo",
    path="path/to/file.md",
    content="# Hello World",
    message="Add new file via MCP"
)
```

---
*Generated by GitHub MCP Server*
"""
        
        print(f"ğŸ“ 3. ìƒˆ íŒŒì¼ ìƒì„± ì¤‘: {test_file_path}")
        
        file_result = await create_or_update_file(
            owner=owner,
            repo=repo,
            path=test_file_path,
            content=test_content,
            message="ğŸ‰ MCP ì„œë²„ë¡œ ìƒˆ íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸",
            branch=new_branch,
            committer_name="MCP Bot",
            committer_email="mcp@example.com"
        )
        
        if file_result["success"]:
            print(f"âœ… íŒŒì¼ ìƒì„± ì„±ê³µ!")
            print(f"   ğŸ“ ê²½ë¡œ: {file_result['data']['path']}")
            print(f"   ğŸ”— URL: {file_result['data']['url']}")
            print(f"   ğŸ†” ì»¤ë°‹ SHA: {file_result['data']['commit_sha'][:8]}")
        else:
            print(f"âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨: {file_result['error']}")
            print(f"   ğŸ“‹ ì „ì²´ ê²°ê³¼: {file_result}")
            return
        
        print()
        
        # 4. íŒŒì¼ ìˆ˜ì •
        updated_content = test_content + "\n\n## ì¶”ê°€ëœ ë‚´ìš© ğŸ†•\n\nì´ ë‚´ìš©ì€ ë‚˜ì¤‘ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"
        
        print(f"âœï¸ 4. íŒŒì¼ ìˆ˜ì • ì¤‘: {test_file_path}")
        
        update_result = await create_or_update_file(
            owner=owner,
            repo=repo,
            path=test_file_path,
            content=updated_content,
            message="ğŸ“ MCP ì„œë²„ë¡œ íŒŒì¼ ìˆ˜ì • í…ŒìŠ¤íŠ¸",
            branch=new_branch,
            committer_name="MCP Bot",
            committer_email="mcp@example.com"
        )
        
        if update_result["success"]:
            print(f"âœ… íŒŒì¼ ìˆ˜ì • ì„±ê³µ!")
            print(f"   ğŸ”„ ì‘ì—…: {update_result['data']['operation']}")
            print(f"   ğŸ†” ì»¤ë°‹ SHA: {update_result['data']['commit_sha'][:8]}")
        else:
            print(f"âŒ íŒŒì¼ ìˆ˜ì • ì‹¤íŒ¨: {update_result['error']}")
        
        print()
        
        # 5. ìµœì¢… ìƒíƒœ í™•ì¸
        print("ğŸ“Š 5. ìµœì¢… ì €ì¥ì†Œ ìƒíƒœ í™•ì¸ ì¤‘...")
        
        final_status = await get_repository_status(owner, repo, new_branch)
        
        if final_status["success"]:
            print(f"âœ… ìµœì¢… ìƒíƒœ:")
            print(f"   ğŸŒ¿ ë¸Œëœì¹˜: {final_status['data']['branch']}")
            print(f"   ğŸ†” ì»¤ë°‹ SHA: {final_status['data']['commit_sha'][:8]}")
            print(f"   ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€: {final_status['data']['commit_message']}")
            print(f"   ğŸ“… ì»¤ë°‹ ë‚ ì§œ: {final_status['data']['commit_date']}")
        else:
            print(f"âŒ ìµœì¢… ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {final_status['error']}")
        
        print()
        print("ğŸ‰ MCP GitHub í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
        print(f"ğŸ”— ì €ì¥ì†Œ: https://github.com/{owner}/{repo}")
        print(f"ğŸŒ¿ ìƒˆ ë¸Œëœì¹˜: {new_branch}")
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
    from dotenv import load_dotenv
    load_dotenv()
    
    # GitHub í† í° í™•ì¸
    if not os.getenv("GITHUB_TOKEN"):
        print("âŒ GITHUB_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("   .env íŒŒì¼ì— GITHUB_TOKEN=your_token_here ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.")
        sys.exit(1)
    
    print("ğŸš€ MCP GitHub ì„œë²„ í…ŒìŠ¤íŠ¸ ì‹œì‘")
    print("=" * 50)
    
    # ë¹„ë™ê¸° ì‹¤í–‰
    asyncio.run(test_github_operations())
